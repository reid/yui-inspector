<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="yui-reset-fonts-grids.css">
    <link rel="stylesheet" href="inspector.css">
</head>
<body>
<div id="hd">
    <h1>Inspector</h1>
</div>

<div id="bd">

<pre id="console"></pre>
</div>

<div id="ft">
    129 modules quuxed.
</div>

<script src="http://yui.yahooapis.com/3.4.1/build/yui/yui-min.js"></script>
<script>
    /*
YUI().use("node", "widget", function (Y) {

    var tabId = null;
    try {
        tabId = chrome.experimental.devtools.inspectedWindow.tabId;
    } catch(e) {}

    function Inspector() {
        Inspector.superclass.constructor.apply(this, arguments);
    }

    Inspector.NAME = "inspector";

    Inspector.ATTRS = {
        tabId: {
            value: tabId
        },
        extension: {
            value: chrome.extension
        }
    };

    Y.extend(Inspector, Y.Widget, {
        initializer: function() {
            document.getElementById("console").innerHTML = "init!";
            this.bindMessage();
        },
        bindMessage: function() {
            var port = this.get("extension").connect({
                name: "inspector-" + this.get("tabId")
            });
            port.onMessage.addListener(Y.bind("onMessage", this));
        },
        onMessage: function(data) {
            if (data.event === "end") {
                this.renderUI();
            } else {
                this.updateUI(data);
            }
        },
        updateUI: function(data) {
            this.get("contentBox").appendChild(Y.Node.create("<div>" + JSON.stringify(data) + "</div>"));
        },
        renderUI: function(data) {
            this.get("contentBox").setContent("Looking for YUI...");
        }
    });

    var i = new Inspector({
        srcNode: "#console"
    })
    i.render();

    //Y.one("#console").setContent("ZOMG");
});
*/
try{

function Inspector(extension, tabId, contentBox) {
    this.connect(extension, tabId);
    this.contentBox = contentBox;
    this.wait();
}

Inspector.prototype.connect = function(extension, tabId) {
    var port = chrome.extension.connect({
        name: "inspector-" + tabId
    });
    port.onMessage.addListener(this.onMessage.bind(this));
};

Inspector.prototype.onMessage = function(data) {
    var c = this.contentBox;
    if (data.event === "end") {
        this.wait();
    } else if (data.event === "heartbeat") {
        this.beat();
    } else if (data.event === "yuiFound") {
        if (data.data) {
            this.contentBox.innerHTML = "";
        } else {
            this.notFound();
        }
    } else {
        this.updateUI(data);
    }
};

Inspector.prototype.updateUI = function(data) {
    var c = this.contentBox;
    c.innerHTML += JSON.stringify(data) + "\n";
};

Inspector.prototype.beat = function() {
    this.contentBox.innerHTML += ".";
};

Inspector.prototype.wait = function() {
    this.contentBox.innerHTML = "Waiting...";
};

Inspector.prototype.notFound = function() {
    this.contentBox.innerHTML = "YUI not found!";
}

new Inspector(chrome.extension,
    chrome.experimental.devtools.inspectedWindow.tabId,
    document.getElementById("console"));

} catch (ex) {
    document.getElementById("console").innerHTML = ex;
}


/*
var tabId = chrome.experimental.devtools.inspectedWindow.tabId;
var c = document.getElementById("console");
function onMessage(data) {
    if (data.event === "end") {
        c.innerHTML = "";
    } else {
        c.innerHTML += JSON.stringify(data) + "\n";
    }
}
*/
</script>
</body>
</html>
