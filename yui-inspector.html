<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="yui-reset-fonts-grids.css">
    <link rel="stylesheet" href="straps.css">
    <link rel="stylesheet" href="yui-inspector.css">
</head>
<body>
<div id="bd">

    <div id="inspector">
    </div>

    <a href="#" onclick="document.querySelector('#inspector').appendChild(document.createElement('hr'));return false">
        Set marker...</a>
    <a href="#" onclick="document.getElementById('debugger').style.display='block';this.parentNode.removeChild(this);return false">
        Show debugger...</a>
    <div id="debugger" style="display: none">
        <h3>The Dump</h3>
        <pre id="c"></pre>
    </div>
</div>

<!--
<div id="ft">
    129 modules quuxed.
</div>
-->

<script src="http://yui.yahooapis.com/3.4.1/build/yui/yui.js"></script>
<script>
YUI({
    filter: "raw"
}).use("node", "widget", "substitute", function (Y) {

    var tabId = null;
    try {
        tabId = chrome.experimental.devtools.inspectedWindow.tabId;
    } catch(e) {}

    function Inspector() {
        Inspector.superclass.constructor.apply(this, arguments);
    }

    Inspector.NAME = "inspector";

    Inspector.ATTRS = {
        extensionTimeout: {
            value: null
        },
        tabId: {
            value: tabId
        },
        extension: {
            // Warning: This is required!
            // Attempting to clone chrome.extension will throw an error.
            cloneDefaultValue: false,
            value: chrome.extension
        },
        yuiFound: {
            value: null
        },
        readyState: {
            value: "unknown"
        }
    };

    var dump = Y.one("#c");

    var create = Y.Node.create;
    var sub = Y.substitute;

    Y.extend(Inspector, Y.Widget, {
        initializer: function() {
        },
        bindAttributes: function() {
            var box = this.get("contentBox").one(".report");

            this.after("yuiFoundChange", function(ev) {
                var yuiFound = ev.newVal;
                if ("string" === typeof yuiFound) {
                    box.appendChild(create(sub("<div class='alert-message success yui'>" +
                        "<strong>YUI {newVal} found.</strong></div>", ev)));
                } else if (yuiFound === false) {
                    box.appendChild(create("<div class='alert-message block-message error yui'>" +
                        "<strong>YUI not found.</strong> Unable to find the YUI object. " +
                        "Check the page and try again.</div>"));
                } else {
                    var message = box.one(".yui");
                    if (message) {
                        message.remove();
                    }
                }
            });

            this.after("readyStateChange", function(ev) {
                var state = ev.newVal;
                var searching = box.one(".searching");
                if (searching) {
                    searching.remove();
                }
                if (state !== "complete") {
                    var html = "<div class='alert-message info block-message searching'>" +
                        "<strong>Searching...</strong> If this message persists, try reloading the page.</div>";
                    box.appendChild(create(html));
                }
            });
        },
        bindMessage: function() {
            var port = this.get("extension").connect({
                name: "inspector-" + this.get("tabId")
            });
            console.log("port = ", port);
            port.onMessage.addListener(Y.bind("onMessage", this));
            port.onDisconnect.addListener(Y.bind("onTimeout", this));
            this.set("extensionTimeout", Y.later(250, this, "onTimeout"));
        },
        onTimeout: function() {
            var box = this.get("contentBox").one(".report");
            box.one(".searching").remove();
            box.appendChild(create("<div class='alert-message block-message error timeout'>" +
                "<strong>No response from the inspected page.</strong> Reload " +
                "and try again.</div>"));
        },
        onMessage: function(data) {
            var extensionTimeout = this.get("extensionTimeout");
            if (extensionTimeout) {
                extensionTimeout.cancel();
                this.set("extensionTimeout", null);
            }

            var error = this.get("contentBox").one(".timeout");
            if (error) {
                error.remove();
            }

            dump.appendChild(create("<pre>" + JSON.stringify(data) + "</pre>"));
            if (data.event === "end") {
                this.resetUI();
            } else {
                this.updateUI(data);
            }
        },
        syncUI: function() {
            this.bindMessage();
            this.bindAttributes();
        },
        updateUI: function(data) {
            if (data.event === "heartbeat") {
                this.set("readyState", "receiving");
            } else if (data.event === "yuiFound") {
                this.set("readyState", "complete");
                this.set("yuiFound", data.data);
            } else if (data.event === "use") {
                this.renderUse(data);
            } else if (data.event === "functionReport") {
                this.renderReport(data);
            }
        },
        renderUse: function(data) {
            var box = this.get("contentBox").one(".timeline");
            var html = create("<pre/>");
            var text = "YUI";
            if (data.data.async) {
                text += "()";
            }
            text += ".use(\"{mods}\") completed in {ms}ms.\n\nMissing modules: {missing}";
            html.setContent(sub(text, {
                mods: data.data.data.modules.join('", "'),
                ms: data.data.duration,
                missing: data.data.data.missing.join(", ") || "N/A"
            }));
            box.appendChild(html);
        },
        renderReport: function(data) {
            var box = this.get("contentBox").one(".profile");
            box.setContent(sub("<div class='alert-message info'>YUI.use called {calls} times.</div>", data.data.stats));
        },
        resetUI: function() {
            var box = this.get("contentBox");
            box.one(".timeline").empty();
            box.one(".profile").empty();
            this.set("readyState", "initializing");
            this.set("yuiFound", null);
        },
        renderUI: function(data) {
            var box = this.get("contentBox");
            box.appendChild(create("<div class='report'><div class='profile'></div>" +
                "</div><div class='timeline'></div>"));
        }
    });

    try {
        var i = new Inspector({
            srcNode: "#inspector"
        });
        i.render();
    } catch (ex) {
        document.getElementById("c").innerHTML = ex.stack;
    }
});
</script>
</body>
</html>
